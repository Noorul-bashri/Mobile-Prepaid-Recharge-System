<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Mobi-Comm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --success-color: #38b000;
      --warning-color: #ffaa00;
      --danger-color: #d90429;
      --light-color: #f8f9fa;
      --dark-color: #212529;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      overflow-x: hidden;
    }
    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
    }
    .header-logo i {
      margin-right: 0.5rem;
      font-size: 1.8rem;
    }
    .header-nav a {
      color: white;
      margin-left: 1.5rem;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .header-nav a:hover {
      color: rgba(255, 255, 255, 0.8);
    }
    /* Footer Styles */
    .footer {
      background-color: #212529;
      color: #f8f9fa;
      padding: 3rem 0 1rem;
    }
    .footer h5 {
      color: white;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    .footer ul {
      list-style: none;
      padding-left: 0;
    }
    .footer ul li {
      margin-bottom: 0.5rem;
    }
    .footer ul li a {
      color: #adb5bd;
      text-decoration: none;
      transition: color 0.3s;
    }
    .footer ul li a:hover {
      color: white;
    }
    .footer-bottom {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 1.5rem;
      margin-top: 2rem;
    }
    .newsletter-form {
      display: flex;
      margin-bottom: 1rem;
    }
    .newsletter-form input {
      flex-grow: 1;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 50px 0 0 50px;
    }
    .newsletter-form button {
      border-radius: 0 50px 50px 0;
      padding: 0.5rem 1.5rem;
      background: var(--primary-color);
      color: white;
      border: none;
      font-weight: 600;
    }
    .subscription-message {
      color: #4cc9f0;
      margin-top: 0.5rem;
      font-weight: 500;
      display: none;
    }
    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, var(--dark-color), #1a1d20);
      min-height: 100vh;
      transition: all 0.3s;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      overflow-y: auto;
      padding-top: 1rem;
    }
    .sidebar .nav-link {
      color: #adb5bd;
      padding: 0.75rem 1.25rem;
      margin: 0.25rem 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }
    .sidebar .nav-link i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
    }
    .sidebar-profile {
      padding: 1.5rem;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 1rem;
    }
    .sidebar-profile img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.2);
      padding: 3px;
    }
    .sidebar-profile h5 {
      color: white;
      margin-top: 1rem;
      font-weight: 600;
    }
    .main-content {
      margin-left: 280px;
      padding: 2rem;
      transition: all 0.3s;
    }
    .banner {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding: 2.5rem 2rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
      color: white;
    }
    .banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IGlkPSJwYXR0ZXJuLWJhY2tncm91bmQiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ij48L3JlY3Q+PHBhdGggZD0iTSAwIDIwIEwgNDAgMjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjEpIiBzdHJva2Utd2lkdGg9IjIiPjwvcGF0aD48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjcGF0dGVybikiPjwvcmVjdD48L3N2Zz4=');
      opacity: 0.2;
      z-index: 1;
    }
    .banner-content {
      position: relative;
      z-index: 2;
    }
    .stats-card {
      border-radius: 1rem;
      border: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
    }
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.1);
    }
    .stats-icon {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 1.5rem;
    }
    .table-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    .table-container .card-header {
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 1.25rem 1.5rem;
    }
    .table-container .table {
      margin-bottom: 0;
    }
    .table-container .table th {
      font-weight: 600;
      color: #6c757d;
      border-top: none;
    }
    .table-container .table td {
      vertical-align: middle;
    }
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    .btn-warning {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: white;
    }
    .btn-warning:hover {
      background-color: #e69500;
      border-color: #e69500;
      color: white;
    }
    @media (max-width: 992px) {
      .sidebar { margin-left: -280px; }
      .sidebar.active { margin-left: 0; }
      .main-content { margin-left: 0; }
      .toggle-sidebar { display: block !important; }
    }
    .toggle-sidebar {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1050;
      display: none;
    }
    .chart-container {
      position: relative;
      margin: auto;
      height: 300px;
      width: 100%;
    }
    .badge-status-active {
      background-color: var(--success-color);
      color: white;
    }
    .badge-status-inactive {
      background-color: var(--danger-color);
      color: white;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header d-none d-lg-block">
    <div class="container">
      <a href="#" class="header-logo">
        <i class="bi bi-broadcast-pin"></i>
        <span>Mobi-Comm</span>
      </a>
      <div class="header-nav">
        <a href="../User/plans.html">Plans</a>
        <a href="#">Support</a>
        <a href="#">Contact</a>
        <a href="#">About Us</a>
      </div>
    </div>
  </header>

  <button class="btn btn-primary toggle-sidebar" id="toggleSidebar">
    <i class="bi bi-list"></i>
  </button>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-profile">
      <img src="https://via.placeholder.com/150" alt="Admin Profile" class="img-fluid">
      <h5>Admin Panel</h5>
    </div>
    <nav class="nav flex-column">
      <a class="nav-link active" href="#dashboard" data-bs-toggle="tab"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
      <a class="nav-link" href="#subscribers" data-bs-toggle="tab"><i class="bi bi-people-fill"></i> Subscribers</a>
      <a class="nav-link" href="#plans" data-bs-toggle="tab"><i class="bi bi-card-list"></i> Plans</a>
      <a class="nav-link" href="#analytics" data-bs-toggle="tab"><i class="bi bi-bar-chart-fill"></i> Analytics</a>
      <a class="nav-link" href="#settings" data-bs-toggle="tab"><i class="bi bi-gear-fill"></i> Settings</a>
      <a class="nav-link" href="../User/plans.html"><i class="bi bi-box-arrow-left"></i> Back to Site</a>
    </nav>
  </div>
  <div class="main-content">
    <div class="banner">
      <div class="banner-content">
        <h2>Mobi-Comm Admin Dashboard</h2>
        <p class="mb-0">Manage subscribers, plans, and monitor performance metrics.</p>
      </div>
    </div>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="dashboard">
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="stats-card card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div><h6 class="text-muted mb-2">Total Subscribers</h6><h3 class="mb-0" id="totalSubscribers">0</h3></div>
                  <div class="stats-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-people-fill"></i></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div><h6 class="text-muted mb-2">Expiring Soon</h6><h3 class="mb-0" id="expiringSubscribers">0</h3></div>
                  <div class="stats-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-clock-fill"></i></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div><h6 class="text-muted mb-2">Active Plans</h6><h3 class="mb-0" id="activePlans">0</h3></div>
                  <div class="stats-icon bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle-fill"></i></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div><h6 class="text-muted mb-2">Most Popular Plan</h6><h3 class="mb-0" id="mostPopularPlan">-</h3></div>
                  <div class="stats-icon bg-info bg-opacity-10 text-info"><i class="bi bi-trophy-fill"></i></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card table-container mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Subscribers with Expiring Plans</h5>
            <span class="badge bg-warning">Next 7 Days</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="expiringSubscribersTable">
                <thead><tr><th>Name</th><th>Phone</th><th>Plan</th><th>Expiry Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="card table-container">
          <div class="card-header"><h5 class="mb-0">Recent Transactions</h5></div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="recentTransactionsTable">
                <thead><tr><th>Date</th><th>Customer</th><th>Plan</th><th>Amount</th><th>Payment Method</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="subscribers">
        <div class="card table-container">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Subscribers</h5>
            <div class="input-group" style="width: 300px;">
              <input type="text" class="form-control" id="subscriberSearch" placeholder="Search subscribers...">
              <button class="btn btn-outline-secondary" type="button" id="searchSubscriberBtn"><i class="bi bi-search"></i></button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="allSubscribersTable">
                <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Current Plan</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="plans">
        <div class="card table-container">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Plan Management</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlanModal"><i class="bi bi-plus-lg"></i> Add Plan</button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="plansTable">
                <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Data</th><th>Validity</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="analytics">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5 class="mb-0">Plan Distribution</h5></div>
              <div class="card-body"><div class="chart-container"><canvas id="planDistributionChart"></canvas></div></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5 class="mb-0">Monthly Subscriptions</h5></div>
              <div class="card-body"><div class="chart-container"><canvas id="monthlySubscriptionsChart"></canvas></div></div>
            </div>
          </div>
          <div class="col-md-12">
            <div class="card">
              <div class="card-header"><h5 class="mb-0">Revenue Trends</h5></div>
              <div class="card-body"><div class="chart-container"><canvas id="revenueTrendsChart"></canvas></div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="settings">
        <div class="card">
          <div class="card-header"><h5 class="mb-0">System Settings</h5></div>
          <div class="card-body">
            <form id="settingsForm">
              <div class="mb-3"><label class="form-label">Company Name</label><input type="text" class="form-control" value="Mobi-Comm Service Pvt Ltd"></div>
              <div class="mb-3"><label class="form-label">Admin Email</label><input type="email" class="form-control" value="admin@mobicomm.com"></div>
              <div class="mb-3">
                <label class="form-label">Notification Settings</label>
                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="emailNotifications" checked><label class="form-check-label" for="emailNotifications">Email Notifications</label></div>
                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="smsNotifications" checked><label class="form-check-label" for="smsNotifications">SMS Notifications</label></div>
              </div>
              <div class="mb-3"><label class="form-label">Data Retention (days)</label><input type="number" class="form-control" value="90"></div>
              <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer (hidden in admin panel but included for consistency) -->
  <footer class="footer d-none">
    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-4">
          <h5>Mobi-Comm Service</h5>
          <p>Connecting People, Anytime, Anywhere.</p>
          <div class="mt-3">
            <a href="#" class="text-light me-3"><i class="bi bi-facebook"></i></a>
            <a href="#" class="text-light me-3"><i class="bi bi-twitter"></i></a>
            <a href="#" class="text-light me-3"><i class="bi bi-instagram"></i></a>
            <a href="#" class="text-light"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        <div class="col-md-2 mb-4">
          <h5>Quick Links</h5>
          <ul>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Plans</a></li>
            <li><a href="#">Support</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </div>
        <div class="col-md-2 mb-4">
          <h5>Resources</h5>
          <ul>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">Privacy Policy</a></li>
            <li><a href="#">Terms & Conditions</a></li>
            <li><a href="#">Refund Policy</a></li>
          </ul>
        </div>
        <div class="col-md-4 mb-4">
          <h5>Subscribe to Our Newsletter</h5>
          <p>Get the latest updates and exclusive offers.</p>
          <form class="newsletter-form" onsubmit="handleSubscription(event)">
            <input type="email" placeholder="Enter your email" required>
            <button type="submit">Subscribe</button>
          </form>
          <div id="subscription-message" class="subscription-message">
            Thank you for subscribing to our newsletter!
          </div>
        </div>
      </div>
      <div class="footer-bottom text-center">
        <p>&copy; 2025 Mobi-Comm Service. All Rights Reserved.</p>
      </div>
    </div>
  </footer>
  
  <div class="modal fade" id="addPlanModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add New Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="addPlanForm">
            <div class="mb-3"><label class="form-label">Plan Name</label><input type="text" class="form-control" name="name" required></div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" name="category" required>
                <option value="">Select Category</option>
                <option value="popular">Popular</option>
                <option value="validity">Validity</option>
                <option value="data">Data</option>
                <option value="topup">Topup</option>
                <option value="entertainment">Entertainment</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            <div class="mb-3"><label class="form-label">Price</label><input type="text" class="form-control" name="price" required></div>
            <div class="mb-3"><label class="form-label">Data</label><input type="text" class="form-control" name="data" required></div>
            <div class="mb-3"><label class="form-label">Validity</label><input type="text" class="form-control" name="validity" required></div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" required>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="savePlanBtn">Save Plan</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editPlanModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="editPlanForm">
            <input type="hidden" name="id" id="editPlanId">
            <div class="mb-3"><label class="form-label">Plan Name</label><input type="text" class="form-control" name="name" id="editPlanName" required></div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" name="category" id="editPlanCategory" required>
                <option value="popular">Popular</option>
                <option value="validity">Validity</option>
                <option value="data">Data</option>
                <option value="topup">Topup</option>
                <option value="entertainment">Entertainment</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            <div class="mb-3"><label class="form-label">Price</label><input type="text" class="form-control" name="price" id="editPlanPrice" required></div>
            <div class="mb-3"><label class="form-label">Data</label><input type="text" class="form-control" name="data" id="editPlanData" required></div>
            <div class="mb-3"><label class="form-label">Validity</label><input type="text" class="form-control" name="validity" id="editPlanValidity" required></div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" id="editPlanStatus" required>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updatePlanBtn">Update Plan</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Transaction History</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="user-info mb-3">
            <h6 id="transactionUserName">User Name</h6>
            <p class="mb-0" id="transactionUserEmail"></p>
            <p class="mb-0" id="transactionUserPhone"></p>
          </div>
          <div class="table-responsive">
            <table class="table" id="transactionTable">
              <thead><tr><th>Date</th><th>Plan</th><th>Payment Mode</th><th>Price</th><th>Expiry Date</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      const sidebar = document.getElementById('sidebar');
      if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', function () {
          sidebar.classList.toggle('active');
        });
      }
      let usersData = [];
      let plansData = {};
      loadAllData();
      async function loadAllData() {
        try {
          const usersResponse = await fetch('http://localhost:3000/users');
          usersData = await usersResponse.json();
          console.log('Users Data:', usersData);
          const categories = ['popularPlans', 'validityPlans', 'dataPlans', 'annualPlans', 'entertainmentPlans', 'topupPlans'];
          plansData = {};
          for (const category of categories) {
            const response = await fetch(`http://localhost:3000/${category}`);
            plansData[category] = await response.json();
          }
          console.log('Plans Data:', plansData);
          updateDashboard();
          populateExpiringSubscribersTable();
          populateRecentTransactionsTable();
          populateAllSubscribersTable();
          populatePlansTable();
          initializeCharts();
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Failed to load data. Please ensure JSON Server is running.');
        }
      }
      function updateDashboard() {
        document.getElementById('totalSubscribers').textContent = usersData.length;
        const now = new Date();
        const sevenDaysLater = new Date(now);
        sevenDaysLater.setDate(now.getDate() + 7);
        const expiringCount = usersData.filter(user =>
          user.transactions && user.transactions.some(t => {
            const expiry = new Date(t.expiryDate);
            return expiry >= now && expiry <= sevenDaysLater;
          })
        ).length;
        document.getElementById('expiringSubscribers').textContent = expiringCount;
        const activePlansCount = Object.values(plansData).reduce((total, plans) => total + plans.length, 0);
        document.getElementById('activePlans').textContent = activePlansCount;
        const planCounts = {};
        usersData.forEach(user => {
          if (user.transactions && user.transactions.length > 0) {
            const latestPlan = user.transactions[0].plan;
            planCounts[latestPlan] = (planCounts[latestPlan] || 0) + 1;
          }
        });
        let mostPopularPlan = '-';
        let maxCount = 0;
        for (const [plan, count] of Object.entries(planCounts)) {
          if (count > maxCount) {
            mostPopularPlan = plan;
            maxCount = count;
          }
        }
        document.getElementById('mostPopularPlan').textContent = mostPopularPlan;
      }
      function populateExpiringSubscribersTable() {
        const tbody = document.querySelector('#expiringSubscribersTable tbody');
        tbody.innerHTML = '';
        const now = new Date();
        const sevenDaysLater = new Date(now);
        sevenDaysLater.setDate(now.getDate() + 7);
        const expiringUsers = usersData.filter(user =>
          user.transactions && user.transactions.some(t => {
            const expiry = new Date(t.expiryDate);
            return expiry >= now && expiry <= sevenDaysLater;
          })
        );
        if (expiringUsers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No subscribers with expiring plans</td></tr>';
          return;
        }
        expiringUsers.forEach(user => {
          const expiringTransaction = user.transactions.find(t => {
            const expiry = new Date(t.expiryDate);
            return expiry >= now && expiry <= sevenDaysLater;
          });
          if (expiringTransaction) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${user.name}</td>
              <td>${user.phone}</td>
              <td>${expiringTransaction.plan}</td>
              <td>${expiringTransaction.expiryDate}</td>
              <td><button class="btn btn-sm btn-primary view-transactions" data-user='${JSON.stringify(user)}'>View History</button></td>
            `;
            tbody.appendChild(tr);
          }
        });
        document.querySelectorAll('.view-transactions').forEach(button => {
          button.addEventListener('click', function () {
            const user = JSON.parse(this.getAttribute('data-user'));
            showTransactionHistory(user);
          });
        });
      }
      function populateRecentTransactionsTable() {
        const tbody = document.querySelector('#recentTransactionsTable tbody');
        tbody.innerHTML = '';
        const allTransactions = [];
        usersData.forEach(user => {
          if (user.transactions) {
            user.transactions.forEach(transaction => {
              allTransactions.push({ ...transaction, userName: user.name, userPhone: user.phone });
            });
          }
        });
        allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recentTransactions = allTransactions.slice(0, 10);
        if (recentTransactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No recent transactions</td></tr>';
          return;
        }
        recentTransactions.forEach(transaction => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.userName}</td>
            <td>${transaction.plan}</td>
            <td>${transaction.price || 'N/A'}</td>
            <td>${transaction.paymentMode}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      function populateAllSubscribersTable() {
        const tbody = document.querySelector('#allSubscribersTable tbody');
        tbody.innerHTML = '';
        if (usersData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No subscribers found</td></tr>';
          return;
        }
        usersData.forEach(user => {
          const currentPlan = user.transactions && user.transactions.length > 0 ? user.transactions[0].plan : 'No active plan';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.phone}</td>
            <td>${currentPlan}</td>
            <td><button class="btn btn-sm btn-primary view-transactions" data-user='${JSON.stringify(user)}'>View History</button></td>
          `;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.view-transactions').forEach(button => {
          button.addEventListener('click', function () {
            const user = JSON.parse(this.getAttribute('data-user'));
            showTransactionHistory(user);
          });
        });
      }
      function populatePlansTable() {
        const tbody = document.querySelector('#plansTable tbody');
        tbody.innerHTML = '';
        const allPlans = [];
        for (const [category, plans] of Object.entries(plansData)) {
          if (Array.isArray(plans)) {
            plans.forEach(plan => {
              allPlans.push({ ...plan, category: category.replace('Plans', '').trim() });
            });
          }
        }
        if (allPlans.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center">No plans found</td></tr>';
          return;
        }
        allPlans.forEach(plan => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${plan.name}</td>
            <td>${plan.category}</td>
            <td>${plan.price}</td>
            <td>${plan.data || plan.talktime || 'N/A'}</td>
            <td>${plan.validity}</td>
            <td><span class="badge ${plan.status === 'Inactive' ? 'badge-status-inactive' : 'badge-status-active'}">${plan.status || 'Active'}</span></td>
            <td>
              <button class="btn btn-sm btn-warning edit-plan" data-plan='${JSON.stringify(plan)}' data-category="${plan.category}"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger delete-plan" data-category="${plan.category}" data-plan-id="${plan.id}"><i class="bi bi-trash"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.edit-plan').forEach(button => {
          button.addEventListener('click', function () {
            const plan = JSON.parse(this.getAttribute('data-plan'));
            const category = this.getAttribute('data-category');
            openEditPlanModal(plan, category);
          });
        });
        document.querySelectorAll('.delete-plan').forEach(button => {
          button.addEventListener('click', function () {
            const category = this.getAttribute('data-category');
            const planId = this.getAttribute('data-plan-id');
            deletePlan(category, planId);
          });
        });
      }
      function showTransactionHistory(user) {
        document.getElementById('transactionUserName').textContent = user.name;
        document.getElementById('transactionUserEmail').textContent = user.email;
        document.getElementById('transactionUserPhone').textContent = user.phone;
        const tbody = document.querySelector('#transactionTable tbody');
        tbody.innerHTML = '';
        if (!user.transactions || user.transactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No transaction history</td></tr>';
        } else {
          const sortedTransactions = [...user.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
          sortedTransactions.forEach(transaction => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${transaction.date}</td>
              <td>${transaction.plan}</td>
              <td>${transaction.paymentMode}</td>
              <td>${transaction.price || 'N/A'}</td>
              <td>${transaction.expiryDate}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
        transactionModal.show();
      }
      function openEditPlanModal(plan, category) {
        document.getElementById('editPlanId').value = plan.id;
        document.getElementById('editPlanName').value = plan.name || '';
        document.getElementById('editPlanCategory').value = category || 'popular';
        document.getElementById('editPlanPrice').value = plan.price || '';
        document.getElementById('editPlanData').value = plan.data || plan.talktime || '';
        document.getElementById('editPlanValidity').value = plan.validity || '';
        document.getElementById('editPlanStatus').value = plan.status || 'Active';
        document.getElementById('editPlanForm').setAttribute('data-category', category + 'Plans');
        const editPlanModal = new bootstrap.Modal(document.getElementById('editPlanModal'));
        editPlanModal.show();
      }
      async function deletePlan(category, planId) {
        if (confirm('Are you sure you want to delete this plan?')) {
          try {
            const response = await fetch(`http://localhost:3000/${category}Plans/${planId}`, {
              method: 'DELETE',
            });
            if (response.ok) {
              alert('Plan deleted successfully!');
              loadAllData();
            } else {
              alert('Failed to delete plan.');
            }
          } catch (error) {
            console.error('Error deleting plan:', error);
            alert('Error deleting plan.');
          }
        }
      }
      document.getElementById('savePlanBtn').addEventListener('click', async function () {
        const form = document.getElementById('addPlanForm');
        const formData = new FormData(form);
        const newPlan = {};
        formData.forEach((value, key) => { newPlan[key] = value; });
        const category = newPlan.category.toLowerCase() + 'Plans';
        delete newPlan.category;
        try {
          const response = await fetch(`http://localhost:3000/${category}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newPlan),
          });
          if (response.ok) {
            alert('Plan added successfully!');
            loadAllData();
            const addPlanModal = bootstrap.Modal.getInstance(document.getElementById('addPlanModal'));
            addPlanModal.hide();
          } else {
            alert('Failed to add plan.');
          }
        } catch (error) {
          console.error('Error adding plan:', error);
          alert('Error adding plan.');
        }
      });
      document.getElementById('updatePlanBtn').addEventListener('click', async function () {
        const form = document.getElementById('editPlanForm');
        const category = form.getAttribute('data-category');
        const planId = document.getElementById('editPlanId').value;
        const updatedPlan = {
          name: document.getElementById('editPlanName').value,
          price: document.getElementById('editPlanPrice').value,
          data: document.getElementById('editPlanData').value,
          validity: document.getElementById('editPlanValidity').value,
          status: document.getElementById('editPlanStatus').value,
        };
        try {
          const response = await fetch(`http://localhost:3000/${category}/${planId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedPlan),
          });
          if (response.ok) {
            alert('Plan updated successfully!');
            loadAllData();
            const editPlanModal = bootstrap.Modal.getInstance(document.getElementById('editPlanModal'));
            editPlanModal.hide();
          } else {
            alert('Failed to update plan.');
          }
        } catch (error) {
          console.error('Error updating plan:', error);
          alert('Error updating plan.');
        }
      });
      function initializeCharts() {
        const planDistributionCtx = document.getElementById('planDistributionChart').getContext('2d');
        const planCategories = {};
        for (const [category, plans] of Object.entries(plansData)) {
          const categoryName = category.replace('Plans', '').trim();
          planCategories[categoryName] = plans.length;
        }
        new Chart(planDistributionCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(planCategories),
            datasets: [{
              data: Object.values(planCategories),
              backgroundColor: ['#4361ee', '#3a0ca3', '#4895ef', '#4cc9f0', '#f72585', '#7209b7'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
          }
        });
        const monthlySubscriptionsCtx = document.getElementById('monthlySubscriptionsChart').getContext('2d');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthlyCounts = Array(12).fill(0);
        usersData.forEach(user => {
          if (user.transactions) {
            user.transactions.forEach(transaction => {
              const date = new Date(transaction.date);
              const month = date.getMonth();
              monthlyCounts[month]++;
            });
          }
        });
        new Chart(monthlySubscriptionsCtx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: 'New Subscriptions',
              data: monthlyCounts,
              backgroundColor: '#4361ee',
              borderColor: '#3a0ca3',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
        const revenueTrendsCtx = document.getElementById('revenueTrendsChart').getContext('2d');
        const monthlyRevenue = Array(12).fill(0);
        usersData.forEach(user => {
          if (user.transactions) {
            user.transactions.forEach(transaction => {
              if (transaction.price) {
                const date = new Date(transaction.date);
                const month = date.getMonth();
                const price = parseFloat(transaction.price.replace(/[^\d.]/g, ''));
                if (!isNaN(price)) monthlyRevenue[month] += price;
              }
            });
          }
        });
        new Chart(revenueTrendsCtx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Monthly Revenue (Rs)',
              data: monthlyRevenue,
              fill: false,
              borderColor: '#4cc9f0',
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      }
      
      // Function to handle newsletter subscription
      window.handleSubscription = function(event) {
        event.preventDefault();
        document.getElementById('subscription-message').style.display = 'block';
      };
    });
  </script>
</body>
</html>